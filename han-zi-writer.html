<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰å­—åºåˆ—ç‰¹è®­ç³»ç»Ÿ (éŸ³æ•ˆå¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body {
            touch-action: none; 
            overscroll-behavior: none;
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f4f8;
            user-select: none;
        }
        
        #canvas-wrapper {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            margin: 0 auto;
            position: relative;
            cursor: crosshair;
            transition: transform 0.1s;
            overflow: hidden;
        }

        .mizige {
            background-image: 
                linear-gradient(0deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(45deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 3px solid #cbd5e1;
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        .progress-bar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: pop 0.6s ease-out forwards;
        }
        @keyframes pop {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .combo-text {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%) scale(0);
            font-weight: 900;
            font-style: italic;
            color: #f59e0b;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 30;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }
        .combo-active {
            transform: translateX(-50%) scale(1.5);
            opacity: 1;
            animation: pulse-combo 0.3s ease-in-out;
        }
        @keyframes pulse-combo {
            0% { transform: translateX(-50%) scale(1.2); }
            50% { transform: translateX(-50%) scale(1.8); }
            100% { transform: translateX(-50%) scale(1.5); }
        }

        .star-pop { animation: star-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0); }
        @keyframes star-pop {
            to { opacity: 1; transform: scale(1); }
        }

        .char-chip.selected {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col items-center text-slate-700 overflow-hidden bg-slate-50">

    <!-- 1. é¡¶éƒ¨ï¼šåˆ†æ•°ä¸è¿›åº¦ -->
    <header class="w-full bg-white shadow-sm z-10 px-4 py-2">
        <div class="max-w-md mx-auto flex flex-col gap-2">
            <!-- æ¸¸æˆåŒ– HUD -->
            <div class="flex justify-between items-end border-b pb-2">
                <div class="flex flex-col">
                    <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">Score</span>
                    <span id="score-display" class="text-3xl font-black text-indigo-600 leading-none">0</span>
                </div>
                
                <div class="flex gap-4 items-center">
                    <button onclick="toggleSound()" id="btn-sound" class="p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors">
                        <!-- é»˜è®¤æ˜¾ç¤ºå¼€å¯éŸ³é‡å›¾æ ‡ -->
                        <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <svg id="icon-sound-off" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v6a3 3 0 0 0 5.12 2.12M15 9.34V4l-6.8 4.48H6a2 2 0 0 0-2 2v2.4"></path></svg>
                    </button>
                    <div class="flex flex-col items-end">
                        <div id="progress-text" class="text-lg font-bold text-slate-700 font-mono">
                            <span class="text-indigo-600 text-2xl">1</span><span class="text-sm opacity-50">/5</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                <div id="progress-indicator" class="progress-bar bg-gradient-to-r from-indigo-500 to-purple-500 h-full shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <!-- 2. ä¸­éƒ¨ï¼šæ¸¸æˆæ ¸å¿ƒåŒº -->
    <main class="flex-1 w-full flex flex-col items-center justify-center gap-4 relative">
        
        <!-- å·¥å…·æ  -->
        <div class="flex gap-2 w-full max-w-xs justify-center relative z-20">
             <button onclick="openOCRModal()" class="bg-white p-2 rounded-xl shadow-sm border border-slate-200 text-slate-500 hover:text-indigo-600 active:scale-95 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
            </button>
            <input type="text" id="lesson-input" value="å¤©é«˜ä»»é¸Ÿé£" 
                   class="w-32 text-center bg-transparent font-bold text-lg border-b-2 border-slate-200 focus:border-indigo-500 outline-none transition-colors"
                   onchange="loadLesson()">
            <button onclick="loadLesson()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition">
                é‡ç½®
            </button>
        </div>

        <!-- å­—æ ¼å®¹å™¨ -->
        <div id="canvas-wrapper" class="relative">
            <div id="character-target-div" class="mizige"></div>
            <div id="combo-display" class="combo-text text-4xl">Combo x2!</div>
            <!-- å®Œæˆæ—¶çš„è¯„ä»·è¦†ç›–å±‚ -->
            <div id="completion-overlay" class="absolute inset-0 z-20 hidden flex-col items-center justify-center bg-white/90 backdrop-blur-sm">
                <div class="flex gap-2 mb-4" id="star-container"></div>
                <div id="completion-msg" class="text-indigo-600 font-black text-2xl mb-2">å®Œç¾!</div>
                <div class="text-sm text-slate-400 font-medium">+50 é¢å¤–å¥–åŠ±</div>
            </div>
        </div>

        <div id="status-msg" class="text-slate-400 font-medium h-6 text-sm transition-all duration-300">
            å‡†å¤‡å¼€å§‹æŒ‘æˆ˜...
        </div>

        <!-- æ¸¸æˆæ§åˆ¶å™¨ -->
        <div class="grid grid-cols-2 gap-4 w-full max-w-xs px-6">
            <button onclick="animateChar()" 
                    class="flex items-center justify-center gap-2 bg-white border-2 border-slate-200 text-slate-600 py-3 rounded-2xl font-bold shadow-sm active:bg-slate-50 hover:border-indigo-200 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                æ¼”ç¤º
            </button>
            <button onclick="startQuiz()" id="btn-quiz"
                    class="flex items-center justify-center gap-2 bg-gradient-to-b from-emerald-400 to-emerald-600 text-white py-3 rounded-2xl shadow-lg shadow-emerald-200 font-black text-lg active:scale-95 transition-transform border-b-4 border-emerald-700 active:border-b-0 active:translate-y-1">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>
                æŒ‘æˆ˜
            </button>
        </div>
        
        <!-- åº•éƒ¨å¼€å…³ -->
         <div class="flex justify-center gap-6 mt-2 opacity-60 hover:opacity-100 transition-opacity">
            <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="auto-next" checked class="accent-indigo-500"> è‡ªåŠ¨ä¸‹ä¸€å…³
            </label>
            <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
                <input type="checkbox" id="show-outline" checked onchange="toggleOutline()" class="accent-indigo-500"> æ˜¾ç¤ºè½®å»“
            </label>
        </div>
    </main>

    <!-- AI OCR Modal -->
    <div id="ocr-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50/50">
                <h3 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                    <span>ğŸ“· AI æ™ºèƒ½è¯†å­—</span>
                    <span class="text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full uppercase tracking-wide">Gemini</span>
                </h3>
                <button onclick="closeOCRModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-5 flex-1 overflow-y-auto">
                 <div class="mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-700 mb-1">Google Gemini API Key (å¿…å¡«)</label>
                    <input type="password" id="api-key-input" placeholder="åœ¨æ­¤ç²˜è´´ Key" 
                           class="w-full px-3 py-2 text-sm bg-white border border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                           onchange="saveApiKey()">
                    <div class="flex justify-between mt-2">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-500 font-bold hover:underline">ğŸ‘‰ è·å–å…è´¹ Key</a>
                        <span id="key-status" class="text-xs text-slate-400">æœªä¿å­˜</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block w-full h-40 border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-indigo-400 transition-all bg-slate-50 relative overflow-hidden group">
                        <input type="file" id="ocr-file-input" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                        <div id="upload-placeholder" class="flex flex-col items-center transition-transform group-hover:scale-110">
                            <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                            <span class="text-sm text-slate-500 font-bold">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ </span>
                        </div>
                        <img id="ocr-preview" class="absolute inset-0 w-full h-full object-cover hidden opacity-60" />
                    </label>
                </div>
                <div id="ocr-status-container" class="flex flex-col items-center justify-center py-4 hidden">
                    <div class="loader mb-2"></div>
                    <div id="ocr-status" class="text-sm text-center text-indigo-600 font-bold">æ­£åœ¨åˆ†æå›¾ç‰‡...</div>
                </div>
                <div id="ocr-result-area" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs font-bold text-slate-400 uppercase">è¯†åˆ«ç»“æœ</p>
                        <button onclick="selectAllChips()" class="text-xs text-indigo-600 font-bold hover:underline">å…¨é€‰</button>
                    </div>
                    <div id="char-chips-container" class="flex flex-wrap gap-2 justify-center bg-slate-50 p-4 rounded-xl border border-slate-200 min-h-[80px]"></div>
                </div>
            </div>
            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button onclick="closeOCRModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-200 rounded-xl transition">å–æ¶ˆ</button>
                <button id="btn-add-selected" onclick="addSelectedChars()" disabled class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-indigo-700 active:scale-95 transition-all">
                    åŠ å…¥æŒ‘æˆ˜
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆå¼•æ“ (Web Audio API) ---
        const SoundEngine = {
            ctx: null,
            isMuted: false,

            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        this.ctx = new AudioContext();
                    }
                }
            },

            // æ’­æ”¾åˆæˆéŸ³æ•ˆ
            playTone: function(freq, type, duration, volume = 0.1, slideTo = null) {
                if (this.isMuted || !this.ctx) return;
                
                // æ¢å¤ä¸Šä¸‹æ–‡ï¼ˆæµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾ï¼‰
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type; // sine, square, sawtooth, triangle
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                if (slideTo) {
                    osc.frequency.exponentialRampToValueAtTime(slideTo, this.ctx.currentTime + duration);
                }

                gain.gain.setValueAtTime(volume, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playCorrect: function(combo = 0) {
                // è¿å‡»è¶Šé«˜ï¼ŒéŸ³è°ƒè¶Šé«˜
                const baseFreq = 500 + (Math.min(combo, 10) * 50);
                // ä½¿ç”¨æ­£å¼¦æ³¢ï¼Œç±»ä¼¼â€œå®â€å£°
                this.playTone(baseFreq, 'sine', 0.3, 0.15); 
                // å åŠ ä¸€ä¸ªé«˜é¢‘æ³›éŸ³
                setTimeout(() => this.playTone(baseFreq * 1.5, 'triangle', 0.2, 0.05), 50);
            },

            playMistake: function() {
                // ä½é¢‘é”¯é½¿æ³¢ï¼Œç±»ä¼¼â€œBuzzâ€
                this.playTone(150, 'sawtooth', 0.3, 0.1, 100);
            },

            playComplete: function() {
                // Cå¤§è°ƒä¸‰å’Œå¼¦ C-E-G-C (å¿«é€Ÿç¶éŸ³)
                const now = this.ctx ? this.ctx.currentTime : 0;
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 'sine', 0.6, 0.1), i * 80);
                });
            }
        };

        // --- æ¸¸æˆçŠ¶æ€ç®¡ç† ---
        const GameState = {
            writer: null,
            charList: [],
            currentIndex: 0,
            score: 0,
            combo: 0,
            mistakesInCurrentChar: 0,
            isQuizzing: false,
            lastPointerX: 0,
            lastPointerY: 0,
            selectedOCRChars: new Set(),
            apiKey: ''
        };

        // --- å…¨å±€äº¤äº’ç›‘å¬ ---
        document.addEventListener('pointermove', (e) => {
            GameState.lastPointerX = e.clientX;
            GameState.lastPointerY = e.clientY;
        });
        document.addEventListener('pointerdown', (e) => {
            GameState.lastPointerX = e.clientX;
            GameState.lastPointerY = e.clientY;
            // ç¬¬ä¸€æ¬¡äº¤äº’æ—¶åˆå§‹åŒ–éŸ³é¢‘å¼•æ“
            SoundEngine.init();
        });

        // --- åˆå§‹åŒ– ---
        function getCanvasSize() {
            const h = window.innerHeight;
            const w = window.innerWidth;
            const availableSize = Math.min(w - 40, h - 350); 
            return Math.max(280, Math.min(availableSize, 380));
        }

        window.onload = function() {
            loadLesson();
            loadApiKey();
            window.addEventListener('resize', debounce(() => {
                initWriter(GameState.charList[GameState.currentIndex]);
            }, 300));
        };

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- æ¸¸æˆé€»è¾‘ï¼šåˆ†æ•°ä¸è¿å‡» ---
        function updateScore(points) {
            const startScore = GameState.score;
            const endScore = startScore + points;
            GameState.score = endScore;
            
            const duration = 500;
            const startTime = performance.now();
            const el = document.getElementById('score-display');
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 4);
                
                const currentVal = Math.floor(startScore + (points * ease));
                el.innerText = currentVal.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    el.innerText = endScore.toLocaleString();
                }
            }
            requestAnimationFrame(animate);
        }

        function updateCombo(reset = false) {
            const el = document.getElementById('combo-display');
            if (reset) {
                GameState.combo = 0;
                el.classList.remove('combo-active');
            } else {
                GameState.combo++;
                if (GameState.combo > 1) {
                    el.innerText = `Combo x${GameState.combo}!`;
                    el.classList.remove('combo-active');
                    void el.offsetWidth; 
                    el.classList.add('combo-active');
                }
            }
        }

        function toggleSound() {
            SoundEngine.isMuted = !SoundEngine.isMuted;
            const onIcon = document.getElementById('icon-sound-on');
            const offIcon = document.getElementById('icon-sound-off');
            if (SoundEngine.isMuted) {
                onIcon.classList.add('hidden');
                offIcon.classList.remove('hidden');
            } else {
                onIcon.classList.remove('hidden');
                offIcon.classList.add('hidden');
                // æ’­æ”¾ä¸€ä¸ªè¯•å¬éŸ³æ•ˆ
                SoundEngine.playTone(440, 'sine', 0.2, 0.1);
            }
        }

        // --- è§†è§‰ç‰¹æ•ˆ ---
        function spawnParticles() {
            const wrapper = document.getElementById('canvas-wrapper');
            const rect = wrapper.getBoundingClientRect();
            
            const x = GameState.lastPointerX - rect.left;
            const y = GameState.lastPointerY - rect.top;

            if (x < 0 || x > rect.width || y < 0 || y > rect.height) return;

            const colors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'];
            
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 6 + 4;
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 60 + 20;
                
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                p.style.width = `${size}px`;
                p.style.height = `${size}px`;
                p.style.backgroundColor = color;
                p.style.left = `${x}px`;
                p.style.top = `${y}px`;
                p.style.setProperty('--tx', `${tx}px`);
                p.style.setProperty('--ty', `${ty}px`);
                
                wrapper.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        }

        // --- è¯¾ç¨‹åŠ è½½ ---
        function loadLesson(overrideText = null) {
            let inputText = overrideText;
            if (inputText === null) {
                inputText = document.getElementById('lesson-input').value;
            } else {
                document.getElementById('lesson-input').value = inputText;
            }

            const chars = inputText.match(/[\u4e00-\u9fa5]/g);
            if (!chars || chars.length === 0) {
                showStatus('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„æ±‰å­—', 'error');
                return;
            }

            GameState.charList = chars;
            GameState.currentIndex = 0;
            GameState.score = 0;
            updateScore(0);
            updateCombo(true);
            
            updateUI();
            initWriter(GameState.charList[0]);
            showStatus(`å‡†å¤‡æŒ‘æˆ˜ï¼šå…± ${chars.length} å…³`, 'normal');
        }

        // --- æ±‰å­—å¼•æ“ ---
        function initWriter(char) {
            const size = getCanvasSize();
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.width = size + 'px';
            wrapper.style.height = size + 'px';

            document.getElementById('character-target-div').innerHTML = ''; 
            document.getElementById('completion-overlay').classList.add('hidden');
            document.getElementById('completion-overlay').classList.remove('flex');

            GameState.mistakesInCurrentChar = 0;
            updateCombo(true);

            GameState.writer = HanziWriter.create('character-target-div', char, {
                width: size,
                height: size,
                padding: 10,
                showOutline: document.getElementById('show-outline').checked,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200,
                strokeColor: '#334155',
                radicalColor: '#4f46e5',
                outlineColor: '#cbd5e1', 
                drawingWidth: 30,
                showHintAfterMisses: 3,
                
                onLoadCharDataError: (err) => {
                    showStatus(`âš ï¸ æ— æ³•åŠ è½½ "${char}"`, 'error');
                },
                onLoadCharDataSuccess: () => {
                     // å¯ä»¥åœ¨è¿™é‡Œé¢„çƒ­éŸ³é¢‘å¼•æ“
                     SoundEngine.init();
                }
            });
        }

        function updateUI() {
            const total = GameState.charList.length;
            const current = GameState.currentIndex + 1;
            
            document.getElementById('progress-text').innerHTML = `<span class="text-indigo-600 text-2xl">${current}</span><span class="text-sm opacity-50">/${total}</span>`;
            
            const percent = ((GameState.currentIndex) / total) * 100;
            document.getElementById('progress-indicator').style.width = `${percent}%`;
        }

        function nextChar() {
            if (GameState.currentIndex < GameState.charList.length - 1) {
                GameState.currentIndex++;
                updateUI();
                initWriter(GameState.charList[GameState.currentIndex]);
                 setTimeout(() => startQuiz(), 600);
            } else {
                 showStatus('ğŸ† æ‰€æœ‰å…³å¡æŒ‘æˆ˜å®Œæˆï¼', 'complete');
                 document.getElementById('progress-indicator').style.width = '100%';
                 SoundEngine.playComplete(); // å†æ¬¡æ’­æ”¾åº†ç¥
            }
        }

        function animateChar() {
            if (GameState.writer) {
                GameState.isQuizzing = false;
                GameState.writer.cancelQuiz();
                GameState.writer.animateCharacter();
                showStatus('æ­£åœ¨è§‚å¯Ÿç¬”é¡º...', 'normal');
            }
        }

        // --- æ ¸å¿ƒæ¸¸æˆå¾ªç¯ ---
        function startQuiz() {
            if (!GameState.writer) return;
            
            GameState.isQuizzing = true;
            GameState.mistakesInCurrentChar = 0;
            updateCombo(true);
            
            showStatus('ğŸ”¥ æŒ‘æˆ˜å¼€å§‹ï¼', 'active');
            
            GameState.writer.quiz({
                onMistake: function(strokeData) {
                    GameState.mistakesInCurrentChar++;
                    updateCombo(true);
                    showStatus('âŒ å¤±è¯¯ï¼è¿å‡»ä¸­æ–­', 'error');
                    
                    // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                    SoundEngine.playMistake();

                    const el = document.getElementById('canvas-wrapper');
                    el.classList.remove('shake');
                    void el.offsetWidth;
                    el.classList.add('shake');
                },
                onCorrectStroke: function(data) {
                    spawnParticles();
                    updateCombo();
                    
                    // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                    SoundEngine.playCorrect(GameState.combo);

                    const comboBonus = Math.min(GameState.combo, 10) * 5;
                    updateScore(10 + comboBonus);
                    
                    showStatus(`âœ… å®Œç¾ï¼Combo x${GameState.combo}`, 'success');
                },
                onComplete: function(summary) {
                    // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
                    SoundEngine.playComplete();
                    handleLevelComplete(summary);
                }
            });
        }

        function handleLevelComplete(summary) {
            const mistakes = GameState.mistakesInCurrentChar;
            let stars = 0;
            let msg = "";
            let color = "";

            if (mistakes === 0) {
                stars = 3;
                msg = "å®Œç¾æ— ç‘•!";
                color = "text-yellow-500";
                updateScore(50);
            } else if (mistakes <= 2) {
                stars = 2;
                msg = "éå¸¸ä¸é”™!";
                color = "text-indigo-500";
                updateScore(20);
            } else {
                stars = 1;
                msg = "ç»§ç»­åŠ æ²¹!";
                color = "text-slate-500";
                updateScore(5);
            }

            const overlay = document.getElementById('completion-overlay');
            const starContainer = document.getElementById('star-container');
            const msgEl = document.getElementById('completion-msg');
            
            starContainer.innerHTML = '';
            msgEl.innerText = msg;
            msgEl.className = `font-black text-3xl mb-2 ${color}`;
            
            for(let i=0; i<3; i++) {
                const svg = document.createElement('div');
                svg.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="${i < stars ? '#f59e0b' : '#e2e8f0'}" stroke="${i < stars ? '#b45309' : '#cbd5e1'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                const el = svg.firstChild;
                el.style.animationDelay = `${i * 150}ms`;
                el.classList.add('star-pop');
                starContainer.appendChild(el);
            }

            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            const autoNext = document.getElementById('auto-next').checked;
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
                if (autoNext) {
                    nextChar();
                }
            }, 2000);
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleOutline() {
            if (GameState.writer) {
                const checked = document.getElementById('show-outline').checked;
                checked ? GameState.writer.showOutline() : GameState.writer.hideOutline();
            }
        }

        function showStatus(text, type) {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            const baseClass = 'text-sm font-bold h-6 transition-all duration-200 ';
            const colors = {
                'error': 'text-red-500 animate-pulse',
                'success': 'text-emerald-500',
                'active': 'text-indigo-500',
                'complete': 'text-purple-600 text-base',
                'normal': 'text-slate-400'
            };
            el.className = baseClass + (colors[type] || colors['normal']);
        }

        // --- OCR & API Key ---
        function loadApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) {
                GameState.apiKey = key;
                document.getElementById('api-key-input').value = key;
                updateKeyStatus(true);
            }
        }
        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                GameState.apiKey = val;
                updateKeyStatus(true);
            } else {
                updateKeyStatus(false);
            }
        }
        function updateKeyStatus(saved) {
            const el = document.getElementById('key-status');
            el.innerText = saved ? 'âœ… å·²å°±ç»ª' : 'æœªä¿å­˜';
            el.className = saved ? 'text-xs text-emerald-500 font-bold' : 'text-xs text-slate-400';
        }
        function openOCRModal() {
            document.getElementById('ocr-modal').classList.remove('hidden');
            resetOCRUI();
        }
        function closeOCRModal() {
            document.getElementById('ocr-modal').classList.add('hidden');
        }
        function resetOCRUI() {
            document.getElementById('ocr-file-input').value = '';
            document.getElementById('ocr-preview').classList.add('hidden');
            document.getElementById('ocr-preview').src = '';
            document.getElementById('ocr-result-area').classList.add('hidden');
            document.getElementById('ocr-status-container').classList.add('hidden');
            document.getElementById('btn-add-selected').disabled = true;
            document.getElementById('char-chips-container').innerHTML = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            GameState.selectedOCRChars.clear();
        }

        async function handleImageUpload(input) {
            if (!GameState.apiKey) {
                alert("è¯·å…ˆè¾“å…¥ Google Gemini API Key æ‰èƒ½è§£é” AI è¯†å­—åŠŸèƒ½ã€‚");
                input.value = '';
                return;
            }
            const file = input.files[0];
            if (!file) return;

            const img = document.getElementById('ocr-preview');
            img.src = URL.createObjectURL(file);
            img.classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');

            const statusContainer = document.getElementById('ocr-status-container');
            const statusText = document.getElementById('ocr-status');
            statusContainer.classList.remove('hidden');
            statusText.innerText = "æ­£åœ¨å‹ç¼©å›¾åƒ...";

            try {
                const base64Data = await compressImage(file);
                statusText.innerText = "AI æ­£åœ¨è¯†åˆ«ä¸­...";
                const resultText = await callGeminiAPI(base64Data);
                statusContainer.classList.add('hidden');
                renderOCRResults(resultText);
            } catch (err) {
                console.error(err);
                statusText.innerText = "è¯†åˆ«ä¸­æ–­: " + (err.message || "ç½‘ç»œé”™è¯¯");
                statusText.className = "text-sm text-center text-red-500 font-bold";
                document.querySelector('.loader').style.display = 'none';
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_SIZE = 1024;
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl.split(',')[1]);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function callGeminiAPI(base64Image) {
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GameState.apiKey}`;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: "è¯·è¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­æ‰€æœ‰çš„æ±‰å­—ï¼ˆåŒ…æ‹¬æ‰‹å†™ä½“å’Œå°åˆ·ä½“ï¼‰ã€‚è¯·å¿½ç•¥æ ‡ç‚¹ç¬¦å·ã€æ‹¼éŸ³å’Œè‹±æ–‡å­—æ¯ã€‚ç›´æ¥è¿”å›æ‰€æœ‰è¯†åˆ«åˆ°çš„æ±‰å­—ï¼Œä½œä¸ºä¸€ä¸ªè¿ç»­çš„å­—ç¬¦ä¸²ã€‚ä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚" },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }]
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'omit'
                });
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `API Error (${response.status})`);
                }
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    throw new Error("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œè¿æ¥ã€‚");
                }
                throw error;
            }
        }

        function renderOCRResults(text) {
            const container = document.getElementById('char-chips-container');
            container.innerHTML = '';
            document.getElementById('ocr-result-area').classList.remove('hidden');
            const chars = text.match(/[\u4e00-\u9fa5]/g);
            if (!chars) {
                container.innerHTML = '<span class="text-slate-400 text-sm font-bold">æœªå‘ç°æ±‰å­—</span>';
                return;
            }
            const uniqueChars = [...new Set(chars)];
            uniqueChars.forEach(char => {
                const chip = document.createElement('button');
                chip.innerText = char;
                chip.className = 'char-chip w-10 h-10 rounded-lg border-2 border-slate-200 bg-white text-lg font-black text-slate-700 shadow-sm hover:border-indigo-400 hover:text-indigo-600 transition-all active:scale-90';
                chip.onclick = () => toggleCharSelection(chip, char);
                container.appendChild(chip);
            });
            checkAddButton();
        }

        function toggleCharSelection(el, char) {
            if (GameState.selectedOCRChars.has(char)) {
                GameState.selectedOCRChars.delete(char);
                el.classList.remove('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                el.classList.add('bg-white', 'text-slate-700', 'border-slate-200');
            } else {
                GameState.selectedOCRChars.add(char);
                el.classList.add('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                el.classList.remove('bg-white', 'text-slate-700', 'border-slate-200');
            }
            checkAddButton();
        }

        function selectAllChips() {
            const chips = document.querySelectorAll('.char-chip');
            chips.forEach(chip => {
                const char = chip.innerText;
                if (!GameState.selectedOCRChars.has(char)) {
                    toggleCharSelection(chip, char);
                }
            });
        }

        function checkAddButton() {
            const btn = document.getElementById('btn-add-selected');
            if (GameState.selectedOCRChars.size > 0) {
                btn.disabled = false;
                btn.innerText = `åŠ å…¥æŒ‘æˆ˜ (${GameState.selectedOCRChars.size})`;
            } else {
                btn.disabled = true;
                btn.innerText = 'åŠ å…¥æŒ‘æˆ˜';
            }
        }

        function addSelectedChars() {
            const newChars = Array.from(GameState.selectedOCRChars).join('');
            loadLesson(newChars);
            closeOCRModal();
        }
    </script>
</body>
</html>
