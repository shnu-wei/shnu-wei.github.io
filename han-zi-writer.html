<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‰å­—åºåˆ—ç‰¹è®­ç³»ç»Ÿ (AIé«˜ç²¾ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body {
            touch-action: none; 
            overscroll-behavior: none;
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        
        #canvas-wrapper {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            margin: 0 auto;
            position: relative;
            cursor: crosshair;
            transition: transform 0.1s;
            overflow: hidden;
        }

        .mizige {
            background-image: 
                linear-gradient(0deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(45deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 2px solid #94a3b8;
            width: 100%;
            height: 100%;
            border-radius: 16px;
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .progress-bar { transition: width 0.3s ease; }

        /* é€‰ä¸­æ±‰å­—æ ‡ç­¾çš„æ ·å¼ */
        .char-chip.selected {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col items-center text-slate-700 overflow-hidden">

    <!-- 1. é¡¶éƒ¨ï¼šè¯¾ç¨‹å¯¼å…¥ä¸è¿›åº¦åŒº -->
    <header class="w-full bg-white shadow-sm z-10 p-4">
        <div class="max-w-md mx-auto">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="flex gap-2 mb-3">
                <input type="text" id="lesson-input" value="å¤©é«˜ä»»é¸Ÿé£" placeholder="è¾“å…¥æˆè¯­æˆ–å¥å­"
                       class="flex-1 border-2 border-slate-200 rounded-lg px-3 py-2 text-lg focus:border-blue-500 focus:outline-none transition-colors">
                
                <!-- ç›¸æœºè¯†åˆ«æŒ‰é’® -->
                <button onclick="openOCRModal()" 
                        class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg border border-indigo-200 transition-colors flex items-center gap-1"
                        title="AI æ‹ç…§è¯†åˆ«">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
                    <span class="text-sm font-bold">AIè¯†å­—</span>
                </button>

                <button onclick="loadLesson()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition-colors whitespace-nowrap">
                    åŠ è½½
                </button>
            </div>

            <!-- è¿›åº¦å¯¼èˆªæ  -->
            <div class="flex items-center justify-between bg-slate-100 rounded-lg p-2">
                <button onclick="prevChar()" id="btn-prev" disabled class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                
                <div class="text-center">
                    <div id="progress-text" class="text-lg font-bold text-slate-700 font-mono">1 / 5</div>
                    <div class="text-xs text-slate-400" id="current-char-display">å½“å‰å­—ï¼šå¤©</div>
                </div>

                <button onclick="nextChar()" id="btn-next" class="p-2 rounded-md hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="w-full bg-slate-200 h-1 mt-0 rounded-full overflow-hidden">
                <div id="progress-indicator" class="progress-bar bg-blue-500 h-full" style="width: 20%"></div>
            </div>
        </div>
    </header>

    <!-- 2. ä¸­éƒ¨ï¼šä¹¦å†™æ ¸å¿ƒåŒº -->
    <main class="flex-1 w-full flex flex-col items-center justify-center gap-4 relative">
        <div id="status-msg" class="text-slate-500 font-medium h-6 text-sm transition-all duration-300">
            å‡†å¤‡å°±ç»ª
        </div>

        <div id="canvas-wrapper" class="relative">
            <div id="character-target-div" class="mizige"></div>
            <div id="completion-overlay" class="absolute inset-0 z-20 hidden items-center justify-center bg-white/80 backdrop-blur-sm">
                <div class="text-emerald-600 font-bold text-2xl animate-bounce">âœ¨ å®Œæˆ!</div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full max-w-xs px-6 mt-2">
            <button onclick="animateChar()" 
                    class="flex items-center justify-center gap-2 bg-white border-2 border-slate-200 text-slate-600 py-3 rounded-xl font-medium active:bg-slate-50">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                æ¼”ç¤º
            </button>
            <button onclick="startQuiz()" id="btn-quiz"
                    class="flex items-center justify-center gap-2 bg-emerald-500 text-white py-3 rounded-xl shadow-lg shadow-emerald-200 font-bold active:scale-95 transition-transform">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>
                æµ‹éªŒ
            </button>
        </div>

        <div class="flex flex-wrap justify-center gap-4 mt-4 px-4">
            <label class="flex items-center gap-2 text-sm text-slate-600 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
                <input type="checkbox" id="auto-next" checked class="accent-blue-500 w-4 h-4">
                <span>è‡ªåŠ¨ä¸‹ä¸€ä¸ª</span>
            </label>
            <label class="flex items-center gap-2 text-sm text-slate-600 bg-white px-3 py-1.5 rounded-full shadow-sm border border-slate-100">
                <input type="checkbox" id="show-outline" checked onchange="toggleOutline()" class="accent-blue-500 w-4 h-4">
                <span>æ˜¾ç¤ºè½®å»“</span>
            </label>
        </div>
    </main>

    <!-- AI OCR å¼¹çª— Modal -->
    <div id="ocr-modal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                    <span>ğŸ“· AI æ™ºèƒ½è¯†å­—</span>
                    <span class="text-xs font-normal text-white bg-indigo-500 px-2 py-0.5 rounded-full">Gemini</span>
                </h3>
                <button onclick="closeOCRModal()" class="text-slate-400 hover:text-slate-600">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                
                <!-- API Key é…ç½®åŒº -->
                <div class="mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-700 mb-1">Google Gemini API Key (å¿…å¡«)</label>
                    <input type="password" id="api-key-input" placeholder="ç²˜è´´æ‚¨çš„ API Key" 
                           class="w-full px-2 py-1 text-sm border border-indigo-200 rounded focus:outline-none focus:border-indigo-500"
                           onchange="saveApiKey()">
                    <div class="flex justify-between mt-1">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-500 underline">è·å–å…è´¹ Key</a>
                        <span id="key-status" class="text-xs text-slate-400">æœªä¿å­˜</span>
                    </div>
                </div>

                <!-- æ–‡ä»¶é€‰æ‹©åŒº -->
                <div class="mb-4">
                    <label class="block w-full h-32 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 transition bg-slate-50 relative overflow-hidden group">
                        <input type="file" id="ocr-file-input" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                        <div id="upload-placeholder" class="flex flex-col items-center">
                            <svg class="w-10 h-10 text-slate-400 mb-2 group-hover:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span class="text-sm text-slate-500 font-medium">ç‚¹å‡»æ‹æ‘„æˆ–é€‰æ‹©å›¾ç‰‡</span>
                        </div>
                        <img id="ocr-preview" class="absolute inset-0 w-full h-full object-cover hidden opacity-50" />
                    </label>
                </div>

                <!-- çŠ¶æ€ä¸è¿›åº¦ -->
                <div id="ocr-status-container" class="flex flex-col items-center justify-center py-4 hidden">
                    <div class="loader mb-2"></div>
                    <div id="ocr-status" class="text-sm text-center text-blue-600 font-medium">æ­£åœ¨è¯·æ±‚ AI åˆ†æ...</div>
                </div>

                <!-- è¯†åˆ«ç»“æœé€‰æ‹©åŒº -->
                <div id="ocr-result-area" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm text-slate-500">è¯†åˆ«ç»“æœ (ç‚¹å‡»é€‰æ‹©):</p>
                        <button onclick="selectAllChips()" class="text-xs text-blue-500 font-medium hover:underline">å…¨é€‰</button>
                    </div>
                    <div id="char-chips-container" class="flex flex-wrap gap-2 justify-center bg-slate-50 p-3 rounded-lg border border-slate-100 min-h-[60px]">
                        <!-- Chips will be injected here -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button onclick="closeOCRModal()" class="flex-1 py-2.5 text-slate-600 font-medium hover:bg-slate-200 rounded-lg">å–æ¶ˆ</button>
                <button id="btn-add-selected" onclick="addSelectedChars()" disabled class="flex-1 py-2.5 bg-indigo-600 text-white font-bold rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-indigo-700 transition-colors">
                    åŠ å…¥ç»ƒä¹ 
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ç®¡ç† ---
        const AppState = {
            writer: null,
            charList: [],
            currentIndex: 0,
            isQuizzing: false,
            selectedOCRChars: new Set(),
            apiKey: ''
        };

        // --- åˆå§‹åŒ– ---
        function getCanvasSize() {
            const h = window.innerHeight;
            const w = window.innerWidth;
            const availableSize = Math.min(w - 40, h - 300); 
            return Math.max(260, Math.min(availableSize, 350));
        }

        window.onload = function() {
            loadLesson();
            loadApiKey(); // åŠ è½½ä¿å­˜çš„ Key
            window.addEventListener('resize', debounce(() => {
                initWriter(AppState.charList[AppState.currentIndex]);
            }, 300));
        };

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // --- API Key ç®¡ç† ---
        function loadApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) {
                AppState.apiKey = key;
                document.getElementById('api-key-input').value = key;
                updateKeyStatus(true);
            }
        }

        function saveApiKey() {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                AppState.apiKey = val;
                updateKeyStatus(true);
            } else {
                updateKeyStatus(false);
            }
        }

        function updateKeyStatus(saved) {
            const el = document.getElementById('key-status');
            if (saved) {
                el.innerText = 'âœ… å·²ä¿å­˜';
                el.className = 'text-xs text-emerald-500 font-bold';
            } else {
                el.innerText = 'æœªä¿å­˜';
                el.className = 'text-xs text-slate-400';
            }
        }

        // --- è¯¾ç¨‹åŠ è½½é€»è¾‘ ---
        function loadLesson(overrideText = null) {
            let inputText = overrideText;
            if (inputText === null) {
                inputText = document.getElementById('lesson-input').value;
            } else {
                document.getElementById('lesson-input').value = inputText;
            }

            const chars = inputText.match(/[\u4e00-\u9fa5]/g);
            
            if (!chars || chars.length === 0) {
                if (overrideText) showStatus('âš ï¸ AI æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ±‰å­—', 'error');
                else showStatus('âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ±‰å­—', 'error');
                return;
            }

            AppState.charList = chars;
            AppState.currentIndex = 0;
            
            updateUI();
            initWriter(AppState.charList[0]);
            showStatus(`åŠ è½½æˆåŠŸï¼šå…± ${chars.length} ä¸ªå­—`, 'normal');
        }

        // --- OCR æ¨¡æ€æ¡†é€»è¾‘ ---
        function openOCRModal() {
            document.getElementById('ocr-modal').classList.remove('hidden');
            resetOCRUI();
        }

        function closeOCRModal() {
            document.getElementById('ocr-modal').classList.add('hidden');
        }

        function resetOCRUI() {
            document.getElementById('ocr-file-input').value = '';
            document.getElementById('ocr-preview').classList.add('hidden');
            document.getElementById('ocr-preview').src = '';
            document.getElementById('ocr-result-area').classList.add('hidden');
            document.getElementById('ocr-status-container').classList.add('hidden');
            document.getElementById('btn-add-selected').disabled = true;
            document.getElementById('char-chips-container').innerHTML = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            AppState.selectedOCRChars.clear();
        }

        // --- æ ¸å¿ƒï¼šGemini API è°ƒç”¨é€»è¾‘ ---
        async function handleImageUpload(input) {
            if (!AppState.apiKey) {
                alert("è¯·å…ˆè¾“å…¥ Google Gemini API Key æ‰èƒ½ä½¿ç”¨ AI è¯†åˆ«åŠŸèƒ½ã€‚");
                input.value = '';
                return;
            }

            const file = input.files[0];
            if (!file) return;

            // UI æ›´æ–°
            const img = document.getElementById('ocr-preview');
            img.src = URL.createObjectURL(file);
            img.classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');

            const statusContainer = document.getElementById('ocr-status-container');
            const statusText = document.getElementById('ocr-status');
            statusContainer.classList.remove('hidden');
            statusText.innerText = "æ­£åœ¨å‹ç¼©å›¾ç‰‡...";

            try {
                // 1. å‹ç¼©å¹¶è½¬æ¢ä¸º Base64 (Gemini é™åˆ¶ Payload å¤§å°)
                const base64Data = await compressImage(file);
                
                // 2. å‘é€è¯·æ±‚
                statusText.innerText = "æ­£åœ¨è¯·æ±‚ AI åˆ†æ (Gemini 2.5)...";
                
                const resultText = await callGeminiAPI(base64Data);
                
                // 3. å¤„ç†ç»“æœ
                statusContainer.classList.add('hidden');
                renderOCRResults(resultText);

            } catch (err) {
                console.error(err);
                statusText.innerText = "è¯†åˆ«å¤±è´¥: " + (err.message || "ç½‘ç»œé”™è¯¯");
                statusText.className = "text-sm text-center text-red-600 font-bold";
                // åœæ­¢åŠ è½½åŠ¨ç”»
                document.querySelector('.loader').style.display = 'none';
            }
        }

        // å›¾ç‰‡å‹ç¼©å·¥å…· (Canvas)
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // é™åˆ¶æœ€å¤§è¾¹é•¿ä¸º 1024pxï¼Œä¿è¯é€Ÿåº¦
                        const MAX_SIZE = 1024;
                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è¾“å‡ºä¸º JPEG base64, è´¨é‡ 0.7
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        // å»æ‰ data:image/jpeg;base64, å‰ç¼€
                        resolve(dataUrl.split(',')[1]);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // è°ƒç”¨ Gemini REST API
        async function callGeminiAPI(base64Image) {
            // ä½¿ç”¨åœ¨é¢„è§ˆç¯å¢ƒä¸­æ›´ç¨³å®šçš„ gemini-2.5-flash-preview-09-2025 æ¨¡å‹
            const model = "gemini-2.5-flash-preview-09-2025";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${AppState.apiKey}`;
            
            // ä¿®æ­£äº† Payload ç»“æ„ï¼Œä½¿ç”¨ inlineData (CamelCase) å¹¶æ·»åŠ  role: "user"
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: "è¯·è¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­æ‰€æœ‰çš„æ±‰å­—ï¼ˆåŒ…æ‹¬æ‰‹å†™ä½“å’Œå°åˆ·ä½“ï¼‰ã€‚è¯·å¿½ç•¥æ ‡ç‚¹ç¬¦å·ã€æ‹¼éŸ³å’Œè‹±æ–‡å­—æ¯ã€‚ç›´æ¥è¿”å›æ‰€æœ‰è¯†åˆ«åˆ°çš„æ±‰å­—ï¼Œä½œä¸ºä¸€ä¸ªè¿ç»­çš„å­—ç¬¦ä¸²ã€‚ä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚" },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'omit' // é˜²æ­¢ CORS é—®é¢˜
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    console.error("Gemini API Error:", errData);
                    throw new Error(errData.error?.message || `API è¯·æ±‚å¤±è´¥ (${response.status})`);
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                // æ•è· Failed to fetch é”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€API Key æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–æ£€æŸ¥æ˜¯å¦å¼€å¯äº†æ‹¦æˆªè·¨åŸŸè¯·æ±‚çš„æ’ä»¶ã€‚");
                }
                throw error;
            }
        }

        // æ¸²æŸ“è¯†åˆ«å‡ºçš„æ±‰å­— Chip
        function renderOCRResults(text) {
            const container = document.getElementById('char-chips-container');
            container.innerHTML = '';
            document.getElementById('ocr-result-area').classList.remove('hidden');
            
            // æå–å”¯ä¸€æ±‰å­—
            const chars = text.match(/[\u4e00-\u9fa5]/g);
            if (!chars) {
                container.innerHTML = '<span class="text-slate-400 text-sm">æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ±‰å­—ï¼Œè¯·é‡è¯•</span>';
                return;
            }

            // è‡ªåŠ¨å»é‡
            const uniqueChars = [...new Set(chars)];

            uniqueChars.forEach(char => {
                const chip = document.createElement('button');
                chip.innerText = char;
                chip.className = 'char-chip w-10 h-10 rounded-lg border border-slate-200 bg-white text-lg font-bold text-slate-700 shadow-sm hover:border-indigo-300 transition-all active:scale-95';
                
                // ä¿®æ”¹ï¼šå»æ‰äº†é»˜è®¤å…¨é€‰çš„é€»è¾‘
                // toggleCharSelection(chip, char); 

                chip.onclick = () => toggleCharSelection(chip, char);
                container.appendChild(chip);
            });

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ­¤æ—¶åº”è¯¥æ˜¯ç¦ç”¨çŠ¶æ€ï¼Œå› ä¸ºä¸€ä¸ªéƒ½æ²¡é€‰ï¼‰
            checkAddButton();
        }

        function toggleCharSelection(el, char) {
            if (AppState.selectedOCRChars.has(char)) {
                AppState.selectedOCRChars.delete(char);
                el.classList.remove('selected', 'ring-2', 'ring-indigo-500');
                el.style.backgroundColor = 'white';
                el.style.color = '#334155';
            } else {
                AppState.selectedOCRChars.add(char);
                el.classList.add('selected', 'ring-2', 'ring-indigo-500');
                el.style.backgroundColor = '#4f46e5'; // indigo-600
                el.style.color = 'white';
            }
            checkAddButton();
        }
        
        function selectAllChips() {
             // é€»è¾‘ï¼šå¦‚æœå½“å‰æ²¡æœ‰å…¨é€‰ï¼Œåˆ™å…¨é€‰ï¼›å¦‚æœå·²ç»å…¨é€‰ï¼Œåˆ™ä¸åŠ¨ä½œæˆ–åé€‰ï¼ˆè¿™é‡Œç®€å•èµ·è§ï¼Œé‡æ–°è§¦å‘å…¨é€‰ï¼‰
             // å®é™…ä¸Šåªéœ€éå† DOM è§¦å‘ç‚¹å‡»é€»è¾‘
             const chips = document.querySelectorAll('.char-chip');
             chips.forEach(chip => {
                 const char = chip.innerText;
                 if (!AppState.selectedOCRChars.has(char)) {
                     // æ¨¡æ‹Ÿç‚¹å‡»é€‰ä¸­
                     toggleCharSelection(chip, char);
                 }
             });
        }

        function checkAddButton() {
            const btn = document.getElementById('btn-add-selected');
            if (AppState.selectedOCRChars.size > 0) {
                btn.disabled = false;
                btn.innerText = `åŠ å…¥ç»ƒä¹  (${AppState.selectedOCRChars.size})`;
            } else {
                btn.disabled = true;
                btn.innerText = 'åŠ å…¥ç»ƒä¹ ';
            }
        }

        function addSelectedChars() {
            const newChars = Array.from(AppState.selectedOCRChars).join('');
            loadLesson(newChars);
            closeOCRModal();
        }

        // --- æ±‰å­—ä¹¦å†™é€»è¾‘ (ä¸å˜) ---
        function initWriter(char) {
            const size = getCanvasSize();
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.width = size + 'px';
            wrapper.style.height = size + 'px';

            const target = document.getElementById('character-target-div');
            target.innerHTML = ''; 

            const overlay = document.getElementById('completion-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }

            AppState.writer = HanziWriter.create('character-target-div', char, {
                width: size,
                height: size,
                padding: 5,
                showOutline: document.getElementById('show-outline').checked,
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200,
                strokeColor: '#334155',
                radicalColor: '#2563eb',
                outlineColor: '#cbd5e1', 
                drawingWidth: 25,
                showHintAfterMisses: 3,
                
                onLoadCharDataError: (err) => {
                    showStatus(`âš ï¸ æš‚æ—  "${char}" çš„ç¬”é¡ºæ•°æ®`, 'error');
                },
            });
        }

        function updateUI() {
            const total = AppState.charList.length;
            const current = AppState.currentIndex + 1;
            const char = AppState.charList[AppState.currentIndex];

            document.getElementById('progress-text').innerText = `${current} / ${total}`;
            document.getElementById('current-char-display').innerText = `å½“å‰å­—ï¼š${char}`;
            
            document.getElementById('btn-prev').disabled = AppState.currentIndex === 0;
            document.getElementById('btn-next').disabled = AppState.currentIndex === total - 1;

            const percent = (current / total) * 100;
            document.getElementById('progress-indicator').style.width = `${percent}%`;
        }

        function nextChar() {
            if (AppState.currentIndex < AppState.charList.length - 1) {
                AppState.currentIndex++;
                updateUI();
                initWriter(AppState.charList[AppState.currentIndex]);
                showStatus('å·²åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå­—', 'normal');
            }
        }

        function prevChar() {
            if (AppState.currentIndex > 0) {
                AppState.currentIndex--;
                updateUI();
                initWriter(AppState.charList[AppState.currentIndex]);
            }
        }

        function animateChar() {
            if (AppState.writer) {
                AppState.isQuizzing = false;
                AppState.writer.cancelQuiz();
                AppState.writer.animateCharacter();
                showStatus('è§‚çœ‹ç¬”é¡ºæ¼”ç¤º', 'normal');
            }
        }

        function startQuiz() {
            if (!AppState.writer) return;
            AppState.isQuizzing = true;
            showStatus('æµ‹éªŒå¼€å§‹ï¼è¯·ä¹¦å†™...', 'active');
            
            AppState.writer.quiz({
                onMistake: function(strokeData) {
                    showStatus('âŒ ç¬”ç”»é”™è¯¯', 'error');
                    const el = document.getElementById('canvas-wrapper');
                    el.classList.remove('shake');
                    void el.offsetWidth;
                    el.classList.add('shake');
                },
                onCorrectStroke: function(data) {
                    showStatus(`âœ… å‰©ä½™ ${data.strokesRemaining} ç¬”`, 'success');
                },
                onComplete: function(summary) {
                    showStatus('ğŸ‰ å®Œæˆï¼', 'complete');
                    const overlay = document.getElementById('completion-overlay');
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');

                    const autoNext = document.getElementById('auto-next').checked;
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        if (autoNext) {
                            if (AppState.currentIndex < AppState.charList.length - 1) {
                                nextChar();
                                setTimeout(() => startQuiz(), 800); 
                            } else {
                                showStatus('ğŸ† æ­å–œï¼æœ¬è¯¾æ‰€æœ‰æ±‰å­—å·²å®Œæˆ', 'complete');
                            }
                        }
                    }, 1200);
                }
            });
        }

        function toggleOutline() {
            if (AppState.writer) {
                const checked = document.getElementById('show-outline').checked;
                checked ? AppState.writer.showOutline() : AppState.writer.hideOutline();
            }
        }

        function showStatus(text, type) {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            el.className = 'text-sm font-medium h-6 transition-colors duration-200 ';
            const colors = {
                'error': 'text-red-500 font-bold',
                'success': 'text-emerald-600',
                'active': 'text-blue-600 font-bold',
                'complete': 'text-purple-600 font-bold text-base',
                'normal': 'text-slate-500'
            };
            el.className += colors[type] || colors['normal'];
        }
    </script>
</body>
</html>
